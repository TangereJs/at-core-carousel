<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-theme/at-theme.html">
<link rel="import" href="../at-i18n/at-i18n-behavior.html">
<link rel="import" href="../at-core-spinner/at-core-spinner.html" />
<link rel="import" href="../at-carbon-message/at-carbon-message.html" />
<link rel="import" href="../at-carbon-icon-color/at-carbon-icon-color.html" />
<link rel="import" href="lib/swiper-styles.html" />
<link rel="import" href="swipe-import.html">


<dom-module id="at-core-carousel">
  <template>
    <style include="swiper-styles">
      :host {
        display: block;
        box-sizing: border-box;
        position: relative;
      }

      .swiper-slide {
        overflow: hidden;
      }

      .swiper-container-no-overlay {
        margin: 0 50px;
      }

      .swiper-pagination-no-overlay {
        position: static;
      }

      /*
       * styles for horizontal scrollable single row carousel when cards have fixed width
       */
      .hide-scrollbar-in-chrome ::-webkit-scrollbar {
        display: none;
      }

      .navigation-as-overlay {
        margin: 0 50px 30px 50px;
      }      

      .button-icon {
        width: 100%;
        height: 100%;
        display: block;
      }
    </style>

    <at-core-spinner id="spinner" type="wave"></at-core-spinner>
    
    <at-carbon-message id="msgEmptyList" type="info"></at-carbon-message>

    <div id="insertContainer" class="swiper-container">
      <div id="insertPoint" class="swiper-wrapper"></div>
      
      <div id="swiperPagination" class="swiper-pagination"></div>
    </div>
    
    <div id="swiperButtonPrev" class="swiper-button-prev" hidden>
      <at-carbon-icon-color icon="now:caret-left" class="button-icon" color="blue"></at-carbon-icon-color>
    </div>
    <div id="swiperButtonNext" class="swiper-button-next" hidden>
      <at-carbon-icon-color icon="now:caret-right" class="button-icon" color="blue"></at-carbon-icon-color>
    </div>      

    <div id="staticItems" hidden>
      <content id="contentInsertPoint" select="*"></content>
    </div>

  </template>
  <script>
    Polymer({
      is: 'at-core-carousel',
      behaviors: [ Tangere.behaviors.i18n ],
      properties: {
        
        items: {
          type: Array,
          value: function() {
            return [];
          }
        },

        itemComponent: {
          type: String,
          value: "",
          notify: true
        },

        cardWidth: {
          type: Number,
          value: 320,
          notify: true
        },

        mode: {
          type: String,
          value: "static",
          xtype: "enum",
          xvaluelist: "static,bound"
        },

        emptyList: {
          type: String,
          value: "No data found"
        },

        centeredSlides: {
          type: Boolean,
          value: false
        },

        navigationAsOverlay: {
          type: Boolean,
          value: false
        },

        spaceBetween: {
          type: Number,
          value: 0
        }
      },

      observers: [
        'initialize(items.*, itemComponent, cardWidth, emptyList)'
      ],

      attached: function() {
        this.isAttached = true;
        this.initialize();
      },

      clear: function() {

        this.$.msgEmptyList.html = ""; // clear error message

        // remove all items
        var insertPoint = Polymer.dom(this.$.insertPoint);
        while(insertPoint.firstChild) {
          insertPoint.removeChild(insertPoint.firstChild);
        }

        Polymer.dom.flush();
      },

      initialize: function() {
        if (!this.isAttached) return;

        // clear previous error message
        this.$.msgEmptyList.html = "";

        var renderMode = this._getRenderMode();

        // check mode and initialize correct data source
        var mode = this.mode;
        if (mode === "bound") {
          this._initializeBoundDataSource(renderMode);

        } else if (mode === "static") {
          this._initializeStaticDataSource(renderMode);

        } else {
          // invalid mode specified
          this.$.msgEmptyList.html = this.T("Mode {0} is invalid.", mode);
        }       
      },

      _initializeBoundDataSource: function(renderMode) {
        var errorCarbonMsg = this.$.msgEmptyList;

        var items = this.items;
        var itemComponent = this.itemComponent;

        if (!itemComponent) {
          errorCarbonMsg.html = this.T("Element name for data rendering not provided.");
          return;
        }

        // validate input parameters
        if (!items) {
          // if items is null or undefined
          errorCarbonMsg.html = this.T("Data for items not provided.");
          return;
        }

        function isArray(obj) {
          return Object.prototype.toString.apply(obj) === "[object Array]";
        }

        // show error if items is an empty array
        if (isArray(items) && items.length === 0) {
          this.$.spinner.display = "none";
          errorCarbonMsg.html = this.emptyList;
          return;
        }

        // clear previously displayed elements
        this.clear();

        // check to see if itemComponent has already been imported
        var found = false;
        var registrations = Polymer.telemetry.registrations;
        for (var i = 0; i < registrations.length && !found; i++) {
          var registration = registrations[i];
          found = registration.is === itemComponent; 
        }

        if (found) {
          // display the available data
          this._bindItems(renderMode);
          return;
        }

        // dynamically load item-component

        // load item-component from other component (itemComponent = component-name/item-component) or from localfolder (item-component)
        var compUrl = this.resolveUrl("../");
        if (window.ComponentsBase != undefined) compUrl = window.ComponentsBase;

        var compName = this.itemComponent;
        var importPath = compName.indexOf("/") >= 0 ? compUrl + compName + ".html" : compName + ".html";

        this.importHref(
          importPath, 
          function success() {
            this._bindItems(renderMode);
          },
          function error() {
            Polymer.signal("busy-end");
            alert(window.location.href + "\n\nERROR: failed to load list item " + this.itemComponent);
            location.hash = ""; // clear current hash
            location.reload(); // go to start app by reloading without hash
          }, true
        );
      },

      _bindItems: function (renderMode) {
        // get correct renderElementName
        var renderElementName = this.itemComponent;
        if (renderElementName.indexOf("/") > 0) {
          renderElementName = renderElementName.substring(1 + renderElementName.lastIndexOf("/"));
        }

        // create swipe item prototype for cloning
        var swipeItemPrototype = document.createElement("div");
        Polymer.dom(swipeItemPrototype).classList.add("swiper-slide");
        if (renderMode === "carousel") {
          swipeItemPrototype.style.width = this.cardWidth + 'px';
        }

        // create render element prototype for cloning
        var renderElementPrototype = document.createElement(renderElementName);

        // get a reference to the insert point
        var insertPoint = this.$.insertPoint;

        // iterate through data, clone swipe/render elements and append to insert point
        this.items.forEach(function(renderItemData){

          var swipeItem = swipeItemPrototype.cloneNode(true);

          var renderElement = document.createElement(renderElementName);
          renderElement.item = renderItemData;

          if (!this.navigationAsOverlay) {
            if (renderMode === "swipe") {
              renderElement.classList.add('navigation-as-overlay');
            } else if (renderMode === "carousel") {
              this.$.insertContainer.classList.add('swiper-container-no-overlay');
              this.$.swiperPagination.classList.add('swiper-pagination-no-overlay');
            }
          }

          Polymer.dom(swipeItem).appendChild(renderElement);
          Polymer.dom(insertPoint).appendChild(swipeItem);
        }, this);

        Polymer.dom.flush();

        // transform ShadyDom styles of innerHTML
        if (!Polymer.Settings.useShadow) {
          Polymer.StyleTransformer.dom(this.$.insertContainer, this.is, true);
        }

        this._createSwipeInstance(renderMode);

        this.fire("list-ready");
      },

      _initializeStaticDataSource: function (renderMode) {

        var insertPoint = Polymer.dom(this.$.insertPoint);

        var swiperSlidePrototype = document.createElement('div');
        swiperSlidePrototype.classList.add('swiper-slide');
        if (renderMode === "carousel") {
          swiperSlidePrototype.style.width = this.cardWidth + 'px';
        }

        var children = this.getEffectiveChildren();
        
        Array.prototype.forEach.call(children, function(child, index){ 
          
          child.parentElement.removeChild(child);          

          var swiperSlide = swiperSlidePrototype.cloneNode(true);
          swiperSlide.appendChild(child);
          insertPoint.appendChild(swiperSlide);

          if (!this.navigationAsOverlay) {
            if (renderMode === "swipe") {
              child.classList.add('navigation-as-overlay');
            } else if (renderMode === "carousel") {
              this.$.insertContainer.classList.add('swiper-container-no-overlay');
              this.$.swiperPagination.classList.add('swiper-pagination-no-overlay');
            }
          }

        }, this);

        Polymer.dom.flush();
        
        this._createSwipeInstance(renderMode);
      },

      _createSwipeInstance: function(renderMode) {
        if (this._swipeInstance) {
          this._swipeInstance.destroy();
        }

        var self = this;

        var swiperOptions = {
          centeredSlides: this.centeredSlides,
          pagination: this.$.swiperPagination,
          nextButton: this.$.swiperButtonNext,
          prevButton: this.$.swiperButtonPrev,
          paginationBulletRender: function(s, i, bulletClass) {
            return '<span class="style-scope at-core-carousel '+ bulletClass +'"></span>';
          },
          paginationClickable: true,
          onInit: function() {
            self.$.spinner.display = 'none';
            self.$.swiperButtonPrev.removeAttribute('hidden');
            self.$.swiperButtonNext.removeAttribute('hidden');
          }
        };

        if (renderMode === "carousel") {
          swiperOptions.slidesPerView = 'auto';
          if (!isNaN(this.spaceBetween)) {
            swiperOptions.spaceBetween = this.spaceBetween;
          }
        }

        this._swipeInstance = new Swiper(this.$.insertContainer, swiperOptions);
      },

      _getRenderMode: function () {
        // we have cardWidth in attributes and property
        var cardWidthAttrValue = this.getAttribute('card-width');
        var cardWidthPropValue = this.cardWidth;

        var result;
        if (cardWidthAttrValue && cardWidthAttrValue.indexOf('%') !== -1 && isNaN(cardWidthPropValue)) {
          result = "swipe";
        } else if (cardWidthAttrValue === "" && cardWidthPropValue === 0) {
          result = "swipe";
        } else {
          result = "carousel";
        }

        return result;
      }

    });
  </script>
</dom-module>
